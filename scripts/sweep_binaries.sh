#!/bin/sh

BASE_DIR="/localhome/jmack2545/ece696b/ember"
BINARY_DIR="${BASE_DIR}/datasets/PortableApps-exes/"
SCRIPT_DIR="${BASE_DIR}/scripts/"
NUM_JOBS=6

PAD_BYTES=5000
MAX_ITER=100
TARGET_CONF=0.95
OUTPUT_DIR="${BASE_DIR}/adversarial_output/"

if [ ! -d "${BASE_DIR}" ]; then
  echo "Base directory ${BASE_DIR} does not exist!"
  exit 1
fi

if [ ! -d "${BINARY_DIR}" ]; then
  echo "Binary directory ${BINARY_DIR} does not exist!"
  exit 1
fi

if [ ! -d "${SCRIPT_DIR}" ]; then
  echo "Base directory ${SCRIPT_DIR} does not exist!"
  exit 1
fi

source /localhome/jmack2545/venv/ece696/bin/activate
cd "${SCRIPT_DIR}"

find ${BINARY_DIR} -iname "*.exe" -printf "%P\n" | parallel --jobs ${NUM_JOBS} "python adversarialize.py --pad_bytes ${PAD_BYTES} --max_iter ${MAX_ITER} --target_confidence ${TARGET_CONF} --output_dir ${OUTPUT_DIR} ${BINARY_DIR}/{} 2>&1 1>${OUTPUT_DIR}/shell_output_{.}.txt"
